{% extends "base.html" %}

{% block title %}Réseau - P2P File Sharing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-globe me-2"></i>
                Fichiers Disponibles sur le Réseau
                <span class="badge bg-success ms-2" id="network-files-count">0</span>
            </div>
            <div class="card-body">
                <!-- Barre de recherche -->
                <div class="row mb-4">
                    <div class="col-md-10">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="search-input" placeholder="Rechercher un fichier..." onkeypress="handleSearchKeyPress(event)">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary btn-lg w-100" onclick="searchFiles()">
                            <i class="fas fa-search me-2"></i>
                            Rechercher
                        </button>
                    </div>
                </div>
                
                <!-- Liste des fichiers -->
                <div id="network-files-list">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x me-2"></i>
                        <p class="mt-3">Chargement des fichiers du réseau...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Téléchargement -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>
                    Téléchargement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Télécharger le fichier :</p>
                <p class="fw-bold" id="download-file-name"></p>
                <div class="progress" style="height: 25px; display: none;" id="download-progress-container">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="download-progress-bar" style="width: 0%">
                        <span id="download-progress-text">0%</span>
                    </div>
                </div>
                <div id="download-status"></div>
                <input type="hidden" id="download-file-id">
                <input type="hidden" id="download-owner-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fermer
                </button>
                <button type="button" class="btn btn-primary" id="start-download-btn" onclick="startDownload()">
                    <i class="fas fa-download me-2"></i>
                    Démarrer le Téléchargement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let downloadModal;

$(document).ready(function() {
    downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
    
    // Charger tous les fichiers au démarrage
    loadNetworkFiles();
    
    // Rafraîchir toutes les 15 secondes
    setInterval(loadNetworkFiles, 15000);
});

function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        searchFiles();
    }
}

function searchFiles() {
    const query = $('#search-input').val().trim();
    
    if (!query) {
        loadNetworkFiles();
        return;
    }
    
    showSpinner();
    
    $.get('/api/files/search', { q: query }, function(data) {
        hideSpinner();
        if (data.success) {
            $('#network-files-count').text(data.results.length);
            renderNetworkFiles(data.results);
        }
    }).fail(function() {
        hideSpinner();
        showNotification('error', 'Erreur lors de la recherche');
    });
}

function loadNetworkFiles() {
    $.get('/api/files/search', { q: '' }, function(data) {
        if (data.success) {
            $('#network-files-count').text(data.results.length);
            renderNetworkFiles(data.results);
        }
    }).fail(function() {
        $('#network-files-list').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Erreur de chargement</div>');
    });
}

function renderNetworkFiles(files) {
    if (files.length === 0) {
        $('#network-files-list').html(`
            <div class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>Aucun fichier trouvé. Essayez une autre recherche.</p>
            </div>
        `);
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead><tr>';
    html += '<th><i class="fas fa-file me-2"></i>Nom</th>';
    html += '<th><i class="fas fa-hdd me-2"></i>Taille</th>';
    html += '<th><i class="fas fa-user me-2"></i>Propriétaire</th>';
    html += '<th><i class="fas fa-signal me-2"></i>Statut</th>';
    html += '<th class="text-end"><i class="fas fa-cog me-2"></i>Actions</th>';
    html += '</tr></thead><tbody>';
    
    files.forEach(function(file) {
        html += '<tr>';
        
        // Nom
        html += '<td>';
        html += '<i class="fas fa-file-alt text-primary me-2"></i>';
        html += '<strong>' + file.name + '</strong>';
        if (file.is_chunked) {
            html += ' <span class="badge bg-info ms-2">';
            html += '<i class="fas fa-th me-1"></i>' + file.chunks_count + ' chunks';
            html += '</span>';
        }
        html += '</td>';
        
        // Taille
        html += '<td>' + formatFileSize(file.size) + '</td>';
        
        // Propriétaire
        html += '<td>';
        html += '<i class="fas fa-user-circle me-2 text-muted"></i>';
        html += (file.owner_name || file.owner_id.substring(0, 8) + '...');
        html += '</td>';
        
        // Statut
        html += '<td>';
        if (file.owner_online) {
            html += '<span class="badge bg-success">';
            html += '<i class="fas fa-circle me-1"></i>En ligne';
            html += '</span>';
        } else {
            html += '<span class="badge bg-secondary">';
            html += '<i class="fas fa-circle me-1"></i>Hors ligne';
            html += '</span>';
        }
        html += '</td>';
        
        // Actions
        html += '<td class="text-end">';
        if (file.owner_online) {
            html += '<button class="btn btn-success btn-sm" onclick="showDownloadModal(\'' + file.id + '\', \'' + file.name + '\', \'' + file.owner_id + '\')">';
            html += '<i class="fas fa-download me-1"></i>Télécharger';
            html += '</button>';
        } else {
            html += '<button class="btn btn-secondary btn-sm" disabled>';
            html += '<i class="fas fa-download me-1"></i>Non disponible';
            html += '</button>';
        }
        html += '</td>';
        
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    $('#network-files-list').html(html);
}

function showDownloadModal(fileId, fileName, ownerId) {
    $('#download-file-id').val(fileId);
    $('#download-file-name').text(fileName);
    $('#download-owner-id').val(ownerId);
    $('#download-status').html('');
    $('#download-progress-container').hide();
    $('#download-progress-bar').css('width', '0%');
    $('#download-progress-text').text('0%');
    $('#start-download-btn').show();
    
    downloadModal.show();
}

function startDownload(forceDownload = false) {
    const fileId = $('#download-file-id').val();
    const ownerId = $('#download-owner-id').val();
    
    // Réinitialiser et afficher la barre de progression
    $('#start-download-btn').hide();
    $('#download-progress-container').show();
    $('#download-progress-bar').css('width', '0%').removeClass('bg-success bg-danger').addClass('progress-bar-animated');
    $('#download-progress-text').text('0%');
    $('#download-status').html('<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Démarrage du téléchargement...</div>');
    
    $.ajax({
        url: '/api/download/start',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            file_id: fileId,
            peer_id: ownerId,
            force_download: forceDownload
        }),
        success: function(data) {
            if (data.success) {
                $('#download-status').html('<div class="alert alert-info mb-0"><i class="fas fa-download me-2"></i>Téléchargement en cours...</div>');
                checkDownloadProgress(data.job_id || data.download_id);
            } else {
                $('#download-status').html('<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>' + (data.error || 'Erreur') + '</div>');
                $('#start-download-btn').show();
                $('#download-progress-container').hide();
            }
        },
        error: function(xhr) {
            if (xhr.responseJSON && xhr.responseJSON.error === 'own_file') {
                // C'est son propre fichier - demander confirmation
                $('#download-progress-container').hide();
                $('#download-status').html(`
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Fichier personnel</strong>
                        <p class="mb-2 mt-2">${xhr.responseJSON.message}</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-warning" onclick="startDownload(true)">
                                <i class="fas fa-download me-1"></i>Oui, télécharger quand même
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="downloadModal.hide()">
                                <i class="fas fa-times me-1"></i>Annuler
                            </button>
                        </div>
                    </div>
                `);
            } else {
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Erreur serveur';
                $('#download-status').html('<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>' + errorMsg + '</div>');
                $('#start-download-btn').show();
                $('#download-progress-container').hide();
            }
        }
    });
}

function checkDownloadProgress(downloadId) {
    // Fonction pour vérifier le statut
    const checkStatus = function() {
        $.get('/api/download/' + downloadId + '/status', function(data) {
            if (data.success && data.job) {
                const job = data.job;
                const progress = Math.round(job.progress || 0);
                
                // Mettre à jour la barre de progression
                $('#download-progress-bar').css('width', progress + '%');
                $('#download-progress-text').text(progress + '%');
                
                console.log('Download progress:', progress + '%', 'Status:', job.status);
                
                if (job.status === 'completed') {
                    clearInterval(interval);
                    $('#download-progress-bar').removeClass('progress-bar-animated').addClass('bg-success');
                    $('#download-status').html('<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>Téléchargement terminé !</div>');
                    showNotification('success', 'Fichier téléchargé avec succès');
                    
                    // Fermer le modal après 2 secondes
                    setTimeout(function() {
                        downloadModal.hide();
                        // Réinitialiser pour le prochain téléchargement
                        $('#start-download-btn').show();
                        $('#download-progress-container').hide();
                        $('#download-progress-bar').css('width', '0%').removeClass('bg-success bg-danger');
                        $('#download-progress-text').text('0%');
                    }, 2000);
                } else if (job.status === 'failed') {
                    clearInterval(interval);
                    $('#download-progress-bar').removeClass('progress-bar-animated').addClass('bg-danger');
                    const errorMsg = job.error_message || 'Erreur lors du téléchargement';
                    $('#download-status').html('<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>' + errorMsg + '</div>');
                    $('#start-download-btn').show();
                }
            }
        }).fail(function(xhr, status, error) {
            clearInterval(interval);
            console.error('Failed to get download status:', error);
            $('#download-status').html('<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>Erreur de connexion</div>');
            $('#start-download-btn').show();
        });
    };
    
    // Appeler immédiatement une première fois
    checkStatus();
    
    // Puis toutes les 500ms
    const interval = setInterval(checkStatus, 500);
}
</script>
{% endblock %}
