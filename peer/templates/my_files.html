{% extends "base.html" %}

{% block title %}Mes Fichiers - P2P File Sharing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-folder me-2"></i>
                    Mes Fichiers Partagés
                    <span class="badge bg-primary ms-2" id="files-count">0</span>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="triggerFileUpload()">
                        <i class="fas fa-plus me-2"></i>
                        Ajouter des Fichiers
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Zone de drag & drop -->
                <div class="upload-area" id="upload-area" onclick="triggerFileUpload()">
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <h5>Glissez vos fichiers ici</h5>
                    <p class="text-muted">ou cliquez pour sélectionner</p>
                    <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileSelect(event)">
                </div>
                
                <!-- Liste des fichiers -->
                <div class="mt-4" id="files-list">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x me-2"></i>
                        <p class="mt-3">Chargement de vos fichiers...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuration des Permissions -->
<div class="modal fade" id="permissionsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-lock me-2"></i>
                    Configuration des Permissions
                </h5>
            </div>
            <div class="modal-body">
                <input type="hidden" id="current-file-id">
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong id="file-name-display"></strong>
                    <span class="badge bg-primary ms-2" id="remaining-files-badge" style="display: none;"></span>
                </div>
                
                <h6 class="mb-3">Comment voulez-vous partager ce fichier ?</h6>
                
                <div class="form-check mb-3 p-3 border rounded">
                    <input class="form-check-input" type="radio" name="shareType" id="sharePublic" value="public" checked>
                    <label class="form-check-label w-100" for="sharePublic">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="fas fa-globe me-2 text-success"></i>Public</strong>
                                <br>
                                <small class="text-muted">Visible par tous les utilisateurs du réseau</small>
                            </div>
                        </div>
                    </label>
                </div>
                
                <div class="form-check mb-3 p-3 border rounded">
                    <input class="form-check-input" type="radio" name="shareType" id="sharePrivate" value="private">
                    <label class="form-check-label w-100" for="sharePrivate">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="fas fa-lock me-2 text-warning"></i>Privé</strong>
                                <br>
                                <small class="text-muted">Visible uniquement par les utilisateurs sélectionnés</small>
                            </div>
                        </div>
                    </label>
                </div>
                
                <div id="peers-selection" style="display: none;" class="mt-3">
                    <h6 class="mb-3">Sélectionner les utilisateurs autorisés</h6>
                    <div id="peers-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Chargement des utilisateurs...
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPeers()">
                            <i class="fas fa-check-double me-1"></i>
                            Tout sélectionner
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllPeers()">
                            <i class="fas fa-times me-1"></i>
                            Tout désélectionner
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cancelConfiguration()">
                    <i class="fas fa-times me-2"></i>
                    Annuler
                </button>
                <button type="button" class="btn btn-outline-secondary" id="skip-btn" style="display: none;" onclick="skipFile()">
                    <i class="fas fa-forward me-2"></i>
                    Passer (rester public)
                </button>
                <button type="button" class="btn btn-primary" onclick="savePermissions()">
                    <i class="fas fa-save me-2"></i>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmation de Suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmer la Suppression
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce fichier ?</p>
                <p class="fw-bold" id="delete-file-name"></p>
                <p class="text-danger">
                    <i class="fas fa-info-circle me-2"></i>
                    Cette action est irréversible et le fichier ne sera plus partagé sur le réseau.
                </p>
                <input type="hidden" id="delete-file-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Annuler
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-2"></i>
                    Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pendingFiles = [];
let currentFileIndex = 0;
let permissionsModal, deleteModal;

$(document).ready(function() {
    // Initialiser les modals
    permissionsModal = new bootstrap.Modal(document.getElementById('permissionsModal'));
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    
    // Charger les fichiers
    loadMyFiles();
    
    // Drag & drop
    const uploadArea = document.getElementById('upload-area');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragging');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragging');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragging');
        handleFiles(e.dataTransfer.files);
    });
    
    // Gestion du changement de type de partage
    $('input[name="shareType"]').on('change', function() {
        if ($('#sharePrivate').is(':checked')) {
            $('#peers-selection').slideDown();
            loadPeersForSelection();
        } else {
            $('#peers-selection').slideUp();
        }
    });
    
    // Rafraîchir toutes les 15 secondes
    setInterval(loadMyFiles, 15000);
});

function triggerFileUpload() {
    document.getElementById('file-input').click();
}

function handleFileSelect(event) {
    handleFiles(event.target.files);
}

function handleFiles(files) {
    if (files.length === 0) return;
    
    const formData = new FormData();
    for (let file of files) {
        formData.append('files', file);
    }
    
    showSpinner();
    showNotification('info', 'Upload des fichiers en cours...');
    
    $.ajax({
        url: '/api/files/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            hideSpinner();
            if (data.success) {
                showNotification('success', data.files_count + ' fichier(s) uploadé(s)');
                // Scanner pour détecter les nouveaux fichiers
                scanNewFiles();
            } else {
                showNotification('error', data.error || 'Erreur lors de l\'upload');
            }
        },
        error: function() {
            hideSpinner();
            showNotification('error', 'Erreur lors de l\'upload des fichiers');
        }
    });
    
    // Réinitialiser l'input
    document.getElementById('file-input').value = '';
}

function scanNewFiles() {
    $.post('/api/files/scan', function(data) {
        if (data.success && data.new_files_count > 0 && data.new_files) {
            // Nouveaux fichiers détectés, ouvrir le modal
            pendingFiles = data.new_files;
            currentFileIndex = 0;
            showNextFilePermissionModal();
        } else {
            // Pas de nouveaux fichiers, synchroniser directement
            syncWithTracker();
            loadMyFiles();
        }
    }).fail(function() {
        showNotification('error', 'Erreur lors du scan');
        loadMyFiles();
    });
}

function showNextFilePermissionModal() {
    if (currentFileIndex >= pendingFiles.length) {
        // Tous les fichiers ont été configurés
        pendingFiles = [];
        currentFileIndex = 0;
        $('#skip-btn').hide();
        showNotification('success', 'Configuration terminée');
        syncWithTracker();
        loadMyFiles();
        return;
    }
    
    const file = pendingFiles[currentFileIndex];
    const remaining = pendingFiles.length - currentFileIndex;
    
    // Remplir le modal
    $('#current-file-id').val(file.id);
    $('#file-name-display').text(file.name);
    
    if (remaining > 1) {
        $('#remaining-files-badge').text(remaining + ' fichier(s) restant(s)').show();
        $('#skip-btn').show();
    } else {
        $('#remaining-files-badge').hide();
        $('#skip-btn').hide();
    }
    
    // Réinitialiser
    $('#sharePublic').prop('checked', true);
    $('#peers-selection').hide();
    $('.peer-checkbox').prop('checked', false);
    
    // Afficher le modal
    permissionsModal.show();
}

function loadPeersForSelection() {
    $.get('/api/peers/all', function(data) {
        if (data.success && data.peers && data.peers.length > 0) {
            renderPeersCheckboxes(data.peers);
        } else {
            $('#peers-list').html('<div class="alert alert-warning mb-0">Aucun autre utilisateur connecté</div>');
        }
    }).fail(function() {
        $('#peers-list').html('<div class="alert alert-danger mb-0">Erreur de chargement</div>');
    });
}

function renderPeersCheckboxes(peers) {
    let html = '';
    peers.forEach(function(peer) {
        const statusBadge = peer.is_online ? 
            '<span class="badge bg-success">En ligne</span>' : 
            '<span class="badge bg-secondary">Hors ligne</span>';
        
        html += '<div class="form-check mb-2 p-2 border-bottom">';
        html += '<input class="form-check-input peer-checkbox" type="checkbox" value="' + peer.id + '" id="peer-' + peer.id + '">';
        html += '<label class="form-check-label w-100" for="peer-' + peer.id + '">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<div>';
        html += '<i class="fas fa-user me-2"></i>' + peer.name;
        html += '<br><small class="text-muted">' + peer.ip_address + ':' + peer.port + '</small>';
        html += '</div>';
        html += statusBadge;
        html += '</div>';
        html += '</label>';
        html += '</div>';
    });
    
    $('#peers-list').html(html);
}

function selectAllPeers() {
    $('.peer-checkbox').prop('checked', true);
}

function deselectAllPeers() {
    $('.peer-checkbox').prop('checked', false);
}

function skipFile() {
    // Passer au fichier suivant sans configuration (reste public)
    currentFileIndex++;
    permissionsModal.hide();
    setTimeout(showNextFilePermissionModal, 300);
}

function cancelConfiguration() {
    if (pendingFiles.length > 0) {
        if (confirm('Annuler la configuration de tous les fichiers restants ? Ils resteront publics.')) {
            pendingFiles = [];
            currentFileIndex = 0;
            $('#skip-btn').hide();
            permissionsModal.hide();
            syncWithTracker();
            loadMyFiles();
        }
    } else {
        permissionsModal.hide();
    }
}

function savePermissions() {
    const fileId = $('#current-file-id').val();
    const isPrivate = $('#sharePrivate').is(':checked');
    const allowedPeers = [];
    
    if (isPrivate) {
        $('.peer-checkbox:checked').each(function() {
            allowedPeers.push($(this).val());
        });
        
        if (allowedPeers.length === 0) {
            showNotification('warning', 'Veuillez sélectionner au moins un utilisateur');
            return;
        }
    }
    
    $.ajax({
        url: '/api/files/' + fileId + '/permissions',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            is_private: isPrivate,
            allowed_peers: allowedPeers
        }),
        success: function(data) {
            if (data.success) {
                const message = isPrivate ? 
                    'Partagé avec ' + allowedPeers.length + ' utilisateur(s)' :
                    'Fichier public';
                showNotification('success', message);
                
                // Si mode multi-fichiers, passer au suivant
                if (pendingFiles.length > 0) {
                    currentFileIndex++;
                    permissionsModal.hide();
                    setTimeout(showNextFilePermissionModal, 300);
                } else {
                    permissionsModal.hide();
                    syncWithTracker();
                    loadMyFiles();
                }
            } else {
                showNotification('error', data.error || 'Erreur lors de la mise à jour');
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Erreur serveur';
            showNotification('error', errorMsg);
        }
    });
}

function syncWithTracker() {
    $.post('/api/files/sync', function(data) {
        console.log('Synchronisation avec le tracker');
    }).fail(function() {
        console.warn('Impossible de synchroniser avec le tracker');
    });
}

function loadMyFiles() {
    $.get('/api/files/local', function(data) {
        if (data.success) {
            $('#files-count').text(data.files.length);
            renderFilesList(data.files);
        }
    }).fail(function() {
        $('#files-list').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Erreur de chargement</div>');
    });
}

function renderFilesList(files) {
    if (files.length === 0) {
        $('#files-list').html(`
            <div class="text-center text-muted py-5">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <p>Aucun fichier partagé. Ajoutez des fichiers pour commencer.</p>
            </div>
        `);
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead><tr>';
    html += '<th><i class="fas fa-file me-2"></i>Nom</th>';
    html += '<th><i class="fas fa-hdd me-2"></i>Taille</th>';
    html += '<th><i class="fas fa-shield-alt me-2"></i>Visibilité</th>';
    html += '<th><i class="fas fa-calendar me-2"></i>Partagé le</th>';
    html += '<th class="text-end"><i class="fas fa-cog me-2"></i>Actions</th>';
    html += '</tr></thead><tbody>';
    
    files.forEach(function(file) {
        html += '<tr>';
        
        // Nom du fichier
        html += '<td>';
        html += '<i class="fas fa-file-alt text-primary me-2"></i>';
        html += '<strong>' + file.name + '</strong>';
        html += '</td>';
        
        // Taille
        html += '<td>' + formatFileSize(file.size) + '</td>';
        
        // Visibilité
        html += '<td>';
        if (file.is_private) {
            const count = file.allowed_peers ? file.allowed_peers.length : 0;
            html += '<span class="badge bg-warning text-dark">';
            html += '<i class="fas fa-lock me-1"></i>Privé (' + count + ')';
            html += '</span>';
        } else {
            html += '<span class="badge bg-success">';
            html += '<i class="fas fa-globe me-1"></i>Public';
            html += '</span>';
        }
        html += '</td>';
        
        // Date
        html += '<td><small class="text-muted">' + formatDate(file.shared_at) + '</small></td>';
        
        // Actions
        html += '<td class="text-end">';
        html += '<div class="btn-group" role="group">';
        html += '<button class="btn btn-sm btn-outline-primary" onclick="editPermissions(\'' + file.id + '\', \'' + file.name + '\')" title="Modifier les permissions">';
        html += '<i class="fas fa-lock"></i>';
        html += '</button>';
        html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteFile(\'' + file.id + '\', \'' + file.name + '\')" title="Supprimer">';
        html += '<i class="fas fa-trash"></i>';
        html += '</button>';
        html += '</div>';
        html += '</td>';
        
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    $('#files-list').html(html);
}

function editPermissions(fileId, fileName) {
    // Réinitialiser les variables de mode multi-fichiers
    pendingFiles = [];
    currentFileIndex = 0;
    
    $('#current-file-id').val(fileId);
    $('#file-name-display').text(fileName);
    $('#remaining-files-badge').hide();
    $('#skip-btn').hide();
    
    // Réinitialiser
    $('#sharePublic').prop('checked', true);
    $('#peers-selection').hide();
    
    permissionsModal.show();
}

function deleteFile(fileId, fileName) {
    $('#delete-file-id').val(fileId);
    $('#delete-file-name').text(fileName);
    deleteModal.show();
}

function confirmDelete() {
    const fileId = $('#delete-file-id').val();
    
    showSpinner();
    
    $.ajax({
        url: '/api/files/' + fileId,
        type: 'DELETE',
        success: function(data) {
            hideSpinner();
            deleteModal.hide();
            
            if (data.success) {
                showNotification('success', 'Fichier supprimé');
                loadMyFiles();
            } else {
                showNotification('error', data.error || 'Erreur lors de la suppression');
            }
        },
        error: function(xhr) {
            hideSpinner();
            const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Erreur serveur';
            showNotification('error', errorMsg);
        }
    });
}
</script>
{% endblock %}
