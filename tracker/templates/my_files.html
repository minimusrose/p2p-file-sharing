{% extends "base.html" %}

{% block title %}Mes Fichiers - Tracker P2P{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-cloud-upload"></i> Mes Fichiers Web
        <span class="badge bg-success">
            <i class="bi bi-wifi"></i> Peer Web Actif
        </span>
    </h1>

    <!-- Info Box -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Partage Web Simplifié :</strong> 
        Uploadez vos fichiers directement depuis le navigateur (max 100 MB). 
        Vos fichiers seront visibles et téléchargeables par tous les utilisateurs (web et desktop).
    </div>

    <!-- Upload Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-upload"></i> Uploader un Fichier
            </h5>
        </div>
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">Choisir un fichier (max 100 MB)</label>
                    <input type="file" class="form-control" id="fileInput" name="file" required>
                    <div class="form-text">
                        Formats acceptés : Tous types de fichiers | Taille maximale : 100 MB
                    </div>
                </div>
                
                <div class="progress mb-3" id="uploadProgress" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="uploadBtn">
                    <i class="bi bi-upload"></i> Partager le Fichier
                </button>
            </form>
        </div>
    </div>

    <!-- My Files List -->
    <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-files"></i> Mes Fichiers Partagés
            </h5>
            <button class="btn btn-sm btn-light" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
            </button>
        </div>
        <div class="card-body">
            {% if my_files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-file-earmark"></i> Nom</th>
                                <th><i class="bi bi-hdd"></i> Taille</th>
                                <th><i class="bi bi-calendar"></i> Partagé le</th>
                                <th><i class="bi bi-download"></i> Téléchargements</th>
                                <th><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in my_files %}
                            <tr id="file-{{ file.id }}">
                                <td>
                                    <i class="bi bi-file-earmark-fill text-primary"></i>
                                    {{ file.name }}
                                </td>
                                <td>{{ (file.size / 1024 / 1024)|round(2) }} MB</td>
                                <td>{{ file.shared_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>
                                    <span class="badge bg-info">{{ file.download_count }}</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('web.web_download', file_id=file.id) }}" 
                                       class="btn btn-sm btn-success" 
                                       title="Télécharger">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="deleteFile('{{ file.id }}', '{{ file.name }}')"
                                            title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-3">Aucun fichier partagé pour le moment.</p>
                    <p>Uploadez votre premier fichier ci-dessus !</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- All Network Files -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="bi bi-globe"></i> Tous les Fichiers du Réseau
            </h5>
        </div>
        <div class="card-body">
            {% if all_files %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Taille</th>
                                <th>Propriétaire</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in all_files %}
                            <tr>
                                <td>
                                    <i class="bi bi-file-earmark"></i> {{ file.name }}
                                </td>
                                <td>{{ (file.size / 1024 / 1024)|round(2) }} MB</td>
                                <td>
                                    {% if file.owner.is_web_peer %}
                                        <span class="badge bg-primary">
                                            <i class="bi bi-globe"></i> Web
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-laptop"></i> Desktop
                                        </span>
                                    {% endif %}
                                    {{ file.owner.name }}
                                </td>
                                <td>
                                    {% if file.owner.is_web_peer %}
                                        <span class="badge bg-success">Téléchargeable</span>
                                    {% else %}
                                        <span class="badge bg-warning">App requise</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.owner.is_web_peer %}
                                        <a href="{{ url_for('web.web_download', file_id=file.id) }}" 
                                           class="btn btn-sm btn-success">
                                            <i class="bi bi-download"></i> Télécharger
                                        </a>
                                    {% else %}
                                        <button class="btn btn-sm btn-secondary" 
                                                disabled 
                                                title="Nécessite l'application desktop">
                                            <i class="bi bi-laptop"></i> App Desktop
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center">Aucun fichier disponible sur le réseau.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Upload Form Handler
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressBar = document.getElementById('uploadProgress');
    const progressBarInner = progressBar.querySelector('.progress-bar');
    
    if (!fileInput.files[0]) {
        alert('Veuillez sélectionner un fichier');
        return;
    }
    
    const file = fileInput.files[0];
    const maxSize = 100 * 1024 * 1024; // 100 MB
    
    if (file.size > maxSize) {
        alert(`Le fichier est trop volumineux (${(file.size / 1024 / 1024).toFixed(2)} MB). Maximum : 100 MB`);
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Disable button and show progress
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Upload en cours...';
    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    
    try {
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBarInner.style.width = percentComplete + '%';
                progressBarInner.textContent = Math.round(percentComplete) + '%';
            }
        });
        
        // Upload complete
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    alert('✅ ' + response.message);
                    location.reload();
                } else {
                    alert('❌ Erreur : ' + response.error);
                    resetUploadForm();
                }
            } else {
                const response = JSON.parse(xhr.responseText);
                alert('❌ Erreur : ' + (response.error || 'Erreur inconnue'));
                resetUploadForm();
            }
        });
        
        // Upload error
        xhr.addEventListener('error', function() {
            alert('❌ Erreur lors de l\'upload');
            resetUploadForm();
        });
        
        xhr.open('POST', '{{ url_for("web.web_upload") }}', true);
        xhr.send(formData);
        
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Erreur : ' + error.message);
        resetUploadForm();
    }
});

function resetUploadForm() {
    const uploadBtn = document.getElementById('uploadBtn');
    const progressBar = document.getElementById('uploadProgress');
    
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Partager le Fichier';
    progressBar.style.display = 'none';
}

// Delete File Function
async function deleteFile(fileId, fileName) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer "${fileName}" ?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/web_delete/${fileId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ ' + data.message);
            // Remove the row from table
            document.getElementById(`file-${fileId}`).remove();
        } else {
            alert('❌ Erreur : ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Erreur lors de la suppression');
    }
}
</script>
{% endblock %}
